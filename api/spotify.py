import os
import json
import random
import requests

from base64 import b64encode
from dotenv import load_dotenv, find_dotenv
from flask import Flask, Response, render_template, request

load_dotenv(find_dotenv())

# Spotify scopes:
#   user-read-currently-playing
#   user-read-recently-played
PLACEHOLDER_IMAGE = "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"

SPOTIFY_CLIENT_ID = os.getenv("SPOTIFY_CLIENT_ID")
SPOTIFY_SECRET_ID = os.getenv("SPOTIFY_SECRET_ID")
SPOTIFY_REFRESH_TOKEN = os.getenv("SPOTIFY_REFRESH_TOKEN")
SPOTIFY_TOKEN = ""

FALLBACK_THEME = "spotify.html.j2"

REFRESH_TOKEN_URL = "https://accounts.spotify.com/api/token"
NOW_PLAYING_URL = "https://api.spotify.com/v1/me/player/currently-playing"
RECENTLY_PLAYING_URL = (
    "https://api.spotify.com/v1/me/player/recently-played?limit=10"
)

app = Flask(__name__)


def getAuth():
    return b64encode(f"{SPOTIFY_CLIENT_ID}:{SPOTIFY_SECRET_ID}".encode()).decode(
        "ascii"
    )


def refreshToken():
    data = {
        "grant_type": "refresh_token",
        "refresh_token": SPOTIFY_REFRESH_TOKEN,
    }

    headers = {"Authorization": "Basic {}".format(getAuth())}
    response = requests.post(
        REFRESH_TOKEN_URL, data=data, headers=headers).json()

    try:
        return response["access_token"]
    except KeyError:
        print(json.dumps(response))
        print("\n---\n")
        raise KeyError(str(response))


def get(url):
    global SPOTIFY_TOKEN

    if (SPOTIFY_TOKEN == ""):
        SPOTIFY_TOKEN = refreshToken()

    response = requests.get(
        url, headers={"Authorization": f"Bearer {SPOTIFY_TOKEN}"})

    if response.status_code == 401:
        SPOTIFY_TOKEN = refreshToken()
        response = requests.get(
            url, headers={"Authorization": f"Bearer {SPOTIFY_TOKEN}"}).json()
        return response
    elif response.status_code == 204:
        raise Exception(f"{url} returned no data.")
    else:
        return response.json()


def barGen(barCount):
    barCSS = ""
    left = 1
    for i in range(1, barCount + 1):
        anim = random.randint(500, 1000)
        # below code generates random cubic-bezier values
        x1 = random.random()
        y1 = random.random()*2
        x2 = random.random()
        y2 = random.random()*2
        barCSS += (
            ".bar:nth-child({})  {{ left: {}px; animation-duration: 15s, {}ms; animation-timing-function: ease, cubic-bezier({},{},{},{}); }}".format(
                i, left, anim, x1, y1, x2, y2
            )
        )
        left += 4
    return barCSS


def getTemplate():
    try:
        file = open("api/templates.json", "r")
        templates = json.loads(file.read())
        return templates["templates"][templates["current-theme"]]
    except Exception as e:
        print(f"Failed to load templates.\r\n```{e}```")
        return FALLBACK_THEME


def loadImageB64(url):
    response = requests.get(url)
    return b64encode(response.content).decode("ascii")


def makeSVG(data, background_color, border_color):
    barCount = 84
    contentBar = "".join(["<div class='bar'></div>" for _ in range(barCount)])
    barCSS = barGen(barCount)

    if not "is_playing" in data:
        # contentBar = "" #Shows/Hides the EQ bar if no song is currently playing
        currentStatus = "Was playing:"
        recentPlays = get(RECENTLY_PLAYING_URL)
        recentPlaysLength = len(recentPlays["items"])
        itemIndex = random.randint(0, recentPlaysLength - 1)
        item = recentPlays["items"][itemIndex]["track"]
    else:
        item = data["item"]
        currentStatus = "Vibing to:"

    if item["album"]["images"] == []:
        image = PLACEHOLDER_IMAGE
    else:
        image = loadImageB64(item["album"]["images"][1]["url"])

    artistName = item["artists"][0]["name"].replace("&", "&amp;")
    songName = item["name"].replace("&", "&amp;")
    songURI = item["external_urls"]["spotify"]
    artistURI = item["artists"][0]["external_urls"]["spotify"]

    dataDict = {
        "contentBar": contentBar,
        "barCSS": barCSS,
        "artistName": artistName,
        "songName": songName,
        "songURI": songURI,
        "artistURI": artistURI,
        "image": image,
        "status": currentStatus,
        "background_color": background_color,
        "border_color": border_color
    }

    return render_template(getTemplate(), **dataDict)


@app.route("/", defaults={"path": ""})
@app.route("/<path:path>")
@app.route('/with_parameters')
def catch_all(path):
    background_color = request.args.get('background_color') or "181414"
    border_color = request.args.get('border_color') or "181414"

    try:
        data = get(NOW_PLAYING_URL)
    except Exception:
        data = get(RECENTLY_PLAYING_URL)

    svg = makeSVG(data, background_color, border_color)

    resp = Response(svg, mimetype="image/svg+xml")
    resp.headers["Cache-Control"] = "s-maxage=1"

    return resp


if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True, port=os.getenv("PORT") or 5000)
